<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Guidelines for developers of R packages interfacing with Stan • rstantools</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Guidelines for developers of R packages interfacing with Stan">
<meta property="og:description" content="rstantools">
<meta property="og:image" content="https://mc-stan.org/rstantools/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstantools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr">cmdstanr</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/rstantools">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Guidelines for developers of R packages interfacing with Stan</h1>
                        <h4 class="author">Stan Development Team</h4>
            
            <h4 class="date">Latest release: July 2020 (First version: November 2016)</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/rstantools/blob/master/vignettes/developer-guidelines.Rmd"><code>vignettes/developer-guidelines.Rmd</code></a></small>
      <div class="hidden name"><code>developer-guidelines.Rmd</code></div>

    </div>

    
    
<div id="note-to-developers" class="section level2">
<h2 class="hasAnchor">
<a href="#note-to-developers" class="anchor"></a>Note to developers</h2>
<p>One of the coolest things about working on a project like Stan has been seeing some of our users begin to develop tools for making Stan more accessible to audiences that may otherwise not benefit from what Stan offers. In particular, recently we have started seeing a growing number of R packages that provide high-level interfaces to Stan, using the <a href="https://mc-stan.org/rstan"><strong>rstan</strong></a> package for estimating models without requiring that the user be familiar with the Stan modeling language itself.</p>
<p>This is a great development and we would like to support such efforts going forward, but to-date we have made little effort to coordinate the development of these packages. To avoid a Wild West, so to speak, of Stan-based R packages, we think it is important that developers make every effort to adhere to certain guidelines in order to ensure these packages are of the highest possible quality and provide the best possible experience for users. To that end, in this post we present a set of recommendations for the development of R packages that interface with Stan. These recommendations are based on software design principles we value as well as many things we are learning as we continue developing our <strong>rstanarm</strong> package and review packages being developed by others.</p>
<p>Of course anyone is free to develop a package based on Stan, even if they ignore these recommendations. However, both because we feel strongly about these recommendations and because we are seeing an increase in the number of requests for help (and our time is unfortunately limited), we will loosely enforce these guidelines by</p>
<ol style="list-style-type: decimal">
<li>prioritizing giving feedback to developers who follow them over those who choose not to, and</li>
<li>refraining from promoting packages that ignore them.</li>
</ol>
<p>That said, we are open to some limited exceptions (e.g., the <strong>brms</strong> package is a sensible exception to one of guidelines about Stan code). If you think your package should be an exception definitely let us know.</p>
</div>
<div id="guidelines-for-r-packages-providing-interfaces-to-stan" class="section level2">
<h2 class="hasAnchor">
<a href="#guidelines-for-r-packages-providing-interfaces-to-stan" class="anchor"></a>Guidelines for R packages providing interfaces to Stan</h2>
<div id="general-package-structure-and-development" class="section level3">
<h3 class="hasAnchor">
<a href="#general-package-structure-and-development" class="anchor"></a>General package structure and development</h3>
<ul>
<li><p>The <strong>rstantools</strong> package provides the <code><a href="../reference/rstan_create_package.html">rstan_create_package()</a></code> function, which you should use to create the basic structure of your package. (As of <code>v2.0.0</code> this replaces the <code>rstan_package_skeleton</code> function.) This will set up a package with functionality for pre-compiled Stan programs, in the style of the <a href="https://mc-stan.org/rstanarm"><strong>rstanarm</strong></a> package (source code: <a href="https://github.com/stan-dev/rstanarm" class="uri">https://github.com/stan-dev/rstanarm</a>).</p></li>
<li><p>Use version control (e.g., git).</p></li>
<li><p>Unless you are developing proprietary private software, organize your code in a repository that is <em>public</em> on <a href="https://github.com/">GitHub</a> (or a similar service, but preferably GitHub). It should be public even at early stages of development, not only when officially released. We recommend you add a note to your README file on how to install the development version of your package, like in the <a href="https://github.com/stan-dev/bayesplot#installation"><strong>bayesplot</strong> README</a></p></li>
<li><p>Unit testing is essential. There are several R packages that make it relatively easy to write tests for your package. Most of our R packages (e.g., <strong>rstanarm</strong>, <strong>brms</strong>, <strong>bayesplot</strong>, <strong>shinystan</strong>, <strong>loo</strong>) use the <a href="https://github.com/r-lib/testthat"><strong>testthat</strong></a> package for this purpose, but if you prefer a different testing framework that’s fine. The <a href="https://github.com/r-lib/covr"><strong>covr</strong></a> package is useful for calculating the line coverage of your tests, and we recommend reaching a high level of coverage before releasing a package. Good line coverage does not guarantee high quality tests, but it’s a good first step.</p></li>
</ul>
</div>
<div id="stan-code" class="section level3">
<h3 class="hasAnchor">
<a href="#stan-code" class="anchor"></a>Stan code</h3>
<ul>
<li><p>All Stan code for estimating models should be included in pre-written static <code>.stan</code> files that are compiled when the package is built (see the Stan programs directory in the <strong>rstanarm</strong> repo for examples). You can also use subdirectories to include code chunks to be used in multiple <code>.stan</code> files (again see the <strong>rstanarm</strong> repo for examples). If you set up your package using <code>rstan_create_package</code> this structure will be created for you. This means that <strong>your package should NOT write a Stan program when the user calls a model fitting function in your package</strong>, but rather use only Stan programs you have written by hand in advance (if you are working on a model for which you don’t think this is possible please let us know). There are several reasons for this.</p></li>
<li><p>Pre-compiled Stan programs can be run by users of Windows or Mac OSX without having to install a C++ compiler, which dramatically expands the universe of potential users for your package.</p></li>
<li><p>Pre-compiled Stan programs will run immediately when called, avoiding compilation time.</p></li>
<li><p>CRAN policy permits long installation times but imposes restrictions on the time consumed by examples and unit tests that are much shorter than the time that it takes to compile even a simple Stan program. Thus, it is only possible to adequately test your package if it has pre-compiled Stan programs.</p></li>
<li><p>Pre-compiled Stan programs can use custom C++ functions.</p></li>
</ul>
<p>To provide flexibility to users, your Stan programs can include branching logic (conditional statements) so that even with a small number of .stan files you can still allow for many different specifications to made by the user (see the .stan files in <strong>rstanarm</strong> for examples).</p>
<ul>
<li><p>Use best practices for Stan code. If the models you intend to implement are discussed in the Stan manual or on the Stan users forum then you should follow any recommendations that apply to your case. If you are unsure whether your Stan programs can be made more efficient or more numerically stable then please ask us on the Stan users forum. Especially ask us if you are unsure whether your Stan programs are indeed estimating the intended model.</p></li>
<li><p>Relatedly, prioritize safety over speed in your Stan code and sampler settings. For example, if you can write a program that runs faster but is potentially less stable, then at a minimum you should make the more stable version the default. This also means that, with rare exceptions, you should not change our recommended MCMC defaults (e.g. 4 chains, 1000+1000 iterations, NUTS not static HMC), unless you are setting the defaults to something more conservative. <strong>rstanarm</strong> even goes one step further, making the default value of the <code>adapt_delta</code> tuning parameter at least 0.95 for all models (rather than <strong>rstan</strong>’s default of 0.8) in order to reduce the step size and therefore also limit the potential for divergences. This means that <strong>rstanarm</strong> models may often run a bit slower than they need to if the user doesn’t change the defaults, but it also means that users face fewer situations in which they need to know how to change the defaults and what the implications of changing the defaults really are.</p></li>
</ul>
</div>
<div id="r-code-and-documentation" class="section level3">
<h3 class="hasAnchor">
<a href="#r-code-and-documentation" class="anchor"></a>R code and documentation</h3>
<ul>
<li><p>Functions that provide useful post-estimation functionality should be given the same names as the corresponding functions in <strong>rstanarm</strong> (if applicable). For example, <code><a href="../reference/posterior_predict.html">posterior_predict()</a></code> to draw from the posterior predictive distribution, <code><a href="../reference/posterior_interval.html">posterior_interval()</a></code> for posterior uncertainty intervals, etc. To make this easier, these and similar <strong>rstanarm</strong> functions have been converted to S3 methods for the stanreg objects created by <strong>rstanarm</strong> and the S3 generic functions are included here in the <strong>rstantools</strong> package. Your package should import the generics from <strong>rstantools</strong> for whichever functions you want to include in your package and then provide methods for the fitted model objects returned by your model-fitting functions. For some other functions (e.g. <code>as.matrix</code>) the generics are already available in base R or core R packages. To be clear, we are not saying that the naming conventions used in <strong>rstanarm</strong>/<strong>rstantools</strong> are necessarily optimal. (If you think that one of our function names should be changed please let us know and suggest an alternative. If it is a substantial improvement we may consider renaming the function and deprecating the current version.) Rather, this guideline is intended to make function names consistent across Stan-based R packages, which will improve the user experience for those users who want to take advantage of a variety of these packages. It will be a mess if every R package using Stan has different names for the same functionality.</p></li>
<li><p>The <a href="https://mc-stan.org/bayesplot/"><strong>bayesplot</strong></a> package serves as the back-end for plotting for <strong>rstanarm</strong> (see for example <code>pp_check.stanreg</code> and <code>plot.stanreg</code>), <strong>brms</strong>, and other packages, and we hope developers of other Stan-based R packages will also use it. You can see all the other R packages using <strong>bayesplot</strong> in the <em>Reverse dependencies</em> section of the <strong>bayesplot</strong> <a href="https://CRAN.R-project.org/package=bayesplot">CRAN page</a>. For any plot you intend to include in your package, if it is already available in <strong>bayesplot</strong> then we recommend using the available version or suggesting (or contributing) a better version. If it is not already available then there is a good chance we will be interested in including it in <strong>bayesplot</strong> if the plot would also be useful for other developers.</p></li>
<li><p>Provide thorough and clear documentation. The documentation won’t be perfect (we’ve found many holes in our <strong>rstanarm</strong> documentation already and there are certainly more), but you should make every effort to provide clear and thorough documentation, using decent grammar and actual sentences wherever possible. The poor quality of the documentation in many (though certainly not all) R packages is insulting to users and an impediment to high quality research. In no way is the current state of R package documentation a reason to insufficiently document your own package. It is unfortunate that this needs to be said, but even a cursory review of popular R packages immediately reveals the necessity for guidelines like this one. Some of our own documentation does not always meet this high standard, but we are consistently making efforts to improve this.</p></li>
</ul>
</div>
<div id="recommended-resources" class="section level3">
<h3 class="hasAnchor">
<a href="#recommended-resources" class="anchor"></a>Recommended resources</h3>
<ul>
<li><p>Hadley Wickham’s <a href="http://r-pkgs.had.co.nz/">book on R packages</a>. If you are interested in developing an R package that interfaces with Stan but are not an experienced package developer, we recommend Hadley’s book, which is free to read online. Even if you are an experienced developer of R packages, Hadley’s book is still a great resource.</p></li>
<li><p>If you need help setting up your package or have questions about these guidelines the best places to go are the <a href="https://discourse.mc-stan.org">Stan Forums</a> and the <a href="https://github.com/stan-dev/rstantools/issues">GitHub issue tracker</a> for the <strong>rstantools</strong> package.</p></li>
</ul>
</div>
</div>
<div id="concluding-remarks" class="section level2">
<h2 class="hasAnchor">
<a href="#concluding-remarks" class="anchor"></a>Concluding remarks</h2>
<p>These guidelines are not set in stone. We expect them to evolve and we very much appreciate feedback on how they can be improved. And, of course, we look forward to seeing the packages you develop using Stan, so please let us know about them!</p>
<p>– The Stan Development Team</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonah Gabry, Ben Goodrich, Martin Lysy.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
